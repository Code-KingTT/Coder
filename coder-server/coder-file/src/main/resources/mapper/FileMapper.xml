<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.coder.mapper.FileMapper">

    <!-- 文件结果映射 -->
    <resultMap type="com.coder.entity.File" id="FileResult">
        <id property="id" column="id"/>
        <result property="fileName" column="file_name"/>
        <result property="filePath" column="file_path"/>
        <result property="fileUrl" column="file_url"/>
        <result property="fileSize" column="file_size"/>
        <result property="fileType" column="file_type"/>
        <result property="mimeType" column="mime_type"/>
        <result property="fileMd5" column="file_md5"/>
        <result property="fileSha1" column="file_sha1"/>
        <result property="category" column="category"/>
        <result property="businessType" column="business_type"/>
        <result property="moduleName" column="module_name"/>
        <result property="businessId" column="business_id"/>
        <result property="storageType" column="storage_type"/>
        <result property="bucketName" column="bucket_name"/>
        <result property="storagePath" column="storage_path"/>
        <result property="chunkSize" column="chunk_size"/>
        <result property="totalChunks" column="total_chunks"/>
        <result property="uploadId" column="upload_id"/>
        <result property="uploadStatus" column="upload_status"/>
        <result property="status" column="status"/>
        <result property="downloadCount" column="download_count"/>
        <result property="viewCount" column="view_count"/>
        <result property="favoriteCount" column="favorite_count"/>
        <result property="accessLevel" column="access_level"/>
        <result property="ownerId" column="owner_id"/>
        <result property="thumbnailPath" column="thumbnail_path"/>
        <result property="duration" column="duration"/>
        <result property="width" column="width"/>
        <result property="height" column="height"/>
        <result property="tags" column="tags"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="createBy" column="create_by"/>
        <result property="updateBy" column="update_by"/>
        <result property="deleted" column="deleted"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 基础字段映射 -->
    <sql id="Base_Column_List">
        id, file_name, file_path, file_url, file_size, file_type, mime_type,
        file_md5, file_sha1, category, business_type, module_name, business_id,
        storage_type, bucket_name, storage_path, chunk_size, total_chunks,
        upload_id, upload_status, status, download_count, view_count, favorite_count,
        access_level, owner_id, thumbnail_path, duration, width, height, tags,
        create_time, update_time, create_by, update_by, deleted, remark
    </sql>

    <!-- 查询条件 -->
    <sql id="selectFileVo">
        SELECT <include refid="Base_Column_List"/> FROM sys_file
    </sql>

    <!-- 插入文件 -->
    <insert id="insert" parameterType="com.coder.entity.File" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_file (
            file_name, file_path, file_url, file_size, file_type, mime_type,
            file_md5, file_sha1, category, business_type, module_name, business_id,
            storage_type, bucket_name, storage_path, chunk_size, total_chunks,
            upload_id, upload_status, status, download_count, view_count, favorite_count,
            access_level, owner_id, thumbnail_path, duration, width, height, tags,
            create_time, update_time, create_by, update_by, deleted, remark
        ) VALUES (
                     #{fileName}, #{filePath}, #{fileUrl}, #{fileSize}, #{fileType}, #{mimeType},
                     #{fileMd5}, #{fileSha1}, #{category}, #{businessType}, #{moduleName}, #{businessId},
                     #{storageType}, #{bucketName}, #{storagePath}, #{chunkSize}, #{totalChunks},
                     #{uploadId}, #{uploadStatus}, #{status}, #{downloadCount}, #{viewCount}, #{favoriteCount},
                     #{accessLevel}, #{ownerId}, #{thumbnailPath}, #{duration}, #{width}, #{height}, #{tags},
                     #{createTime}, #{updateTime}, #{createBy}, #{updateBy}, #{deleted}, #{remark}
                 )
    </insert>

    <!-- 根据ID删除文件（逻辑删除） -->
    <update id="deleteById">
        UPDATE sys_file
        SET deleted = 1, update_time = NOW(), update_by = #{updateBy}
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 批量删除文件（逻辑删除） -->
    <update id="deleteBatchByIds">
        UPDATE sys_file
        SET deleted = 1, update_time = NOW(), update_by = #{updateBy}
        WHERE deleted = 0 AND id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 更新文件 -->
    <update id="updateById" parameterType="com.coder.entity.File">
        UPDATE sys_file
        <set>
            <if test="fileName != null and fileName != ''">file_name = #{fileName},</if>
            <if test="fileUrl != null">file_url = #{fileUrl},</if>
            <if test="category != null">category = #{category},</if>
            <if test="businessType != null">business_type = #{businessType},</if>
            <if test="moduleName != null">module_name = #{moduleName},</if>
            <if test="businessId != null">business_id = #{businessId},</if>
            <if test="uploadStatus != null">upload_status = #{uploadStatus},</if>
            <if test="status != null">status = #{status},</if>
            <if test="accessLevel != null">access_level = #{accessLevel},</if>
            <if test="thumbnailPath != null">thumbnail_path = #{thumbnailPath},</if>
            <if test="tags != null">tags = #{tags},</if>
            <if test="remark != null">remark = #{remark},</if>
            update_time = #{updateTime},
            update_by = #{updateBy}
        </set>
        WHERE id = #{id} AND deleted = 0
    </update>

    <!-- 根据ID查询文件 -->
    <select id="selectById" parameterType="Long" resultMap="FileResult">
        <include refid="selectFileVo"/>
        WHERE id = #{id} AND deleted = 0
    </select>

    <!-- 根据MD5查询文件 -->
    <select id="selectByMd5" parameterType="String" resultMap="FileResult">
        <include refid="selectFileVo"/>
        WHERE file_md5 = #{fileMd5} AND deleted = 0
        LIMIT 1
    </select>

    <!-- 分页查询文件列表 -->
    <select id="selectPageList" parameterType="com.coder.dto.FileQueryDTO" resultMap="FileResult">
        <include refid="selectFileVo"/>
        <where>
            deleted = 0
            <if test="fileName != null and fileName != ''">
                AND file_name LIKE CONCAT('%', #{fileName}, '%')
            </if>
            <if test="fileType != null and fileType != ''">
                AND file_type = #{fileType}
            </if>
            <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <if test="businessType != null and businessType != ''">
                AND business_type = #{businessType}
            </if>
            <if test="moduleName != null and moduleName != ''">
                AND module_name = #{moduleName}
            </if>
            <if test="businessId != null">
                AND business_id = #{businessId}
            </if>
            <if test="storageType != null and storageType != ''">
                AND storage_type = #{storageType}
            </if>
            <if test="uploadStatus != null">
                AND upload_status = #{uploadStatus}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="accessLevel != null">
                AND access_level = #{accessLevel}
            </if>
            <if test="ownerId != null">
                AND owner_id = #{ownerId}
            </if>
            <if test="tags != null and tags != ''">
                AND tags LIKE CONCAT('%', #{tags}, '%')
            </if>
            <if test="createTimeStart != null and createTimeStart != ''">
                AND create_time >= #{createTimeStart}
            </if>
            <if test="createTimeEnd != null and createTimeEnd != ''">
                AND create_time &lt;= #{createTimeEnd}
            </if>
        </where>
        ORDER BY create_time DESC
    </select>

    <!-- 查询文件总数 -->
    <select id="selectCount" parameterType="com.coder.dto.FileQueryDTO" resultType="Long">
        SELECT COUNT(1) FROM sys_file
        <where>
            deleted = 0
            <if test="fileName != null and fileName != ''">
                AND file_name LIKE CONCAT('%', #{fileName}, '%')
            </if>
            <if test="fileType != null and fileType != ''">
                AND file_type = #{fileType}
            </if>
            <if test="category != null and category != ''">
                AND category = #{category}
            </if>
            <if test="businessType != null and businessType != ''">
                AND business_type = #{businessType}
            </if>
            <if test="moduleName != null and moduleName != ''">
                AND module_name = #{moduleName}
            </if>
            <if test="businessId != null">
                AND business_id = #{businessId}
            </if>
            <if test="storageType != null and storageType != ''">
                AND storage_type = #{storageType}
            </if>
            <if test="uploadStatus != null">
                AND upload_status = #{uploadStatus}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
            <if test="accessLevel != null">
                AND access_level = #{accessLevel}
            </if>
            <if test="ownerId != null">
                AND owner_id = #{ownerId}
            </if>
            <if test="tags != null and tags != ''">
                AND tags LIKE CONCAT('%', #{tags}, '%')
            </if>
            <if test="createTimeStart != null and createTimeStart != ''">
                AND create_time >= #{createTimeStart}
            </if>
            <if test="createTimeEnd != null and createTimeEnd != ''">
                AND create_time &lt;= #{createTimeEnd}
            </if>
        </where>
    </select>

    <!-- 更新文件统计数据 -->
    <update id="updateFileStats">
        UPDATE sys_file
        SET ${field} = ${field} + 1, update_time = NOW()
        WHERE id = #{id} AND deleted = 0
    </update>

</mapper>